CREATE TEMP TABLE tbl_tableau_ingestion_records_temp (title varchar(100), id_order integer, id integer, job_name varchar(25), progress integer, first_published_at_utc timestamp, created_at_utc timestamp, started_at_utc timestamp, updated_at_utc timestamp, completed_at_utc timestamp,  runtime_sec integer, finish_code integer, priority integer, backgrounder_id varchar(20), new_extract_id varchar(50), datasources_size bigint, extract_size bigint, db_class varchar(20), state varchar(10), owner_type varchar(20)); 

\copy tbl_tableau_ingestion_records_temp (title, id_order, id, job_name, progress, first_published_at_utc, created_at_utc, started_at_utc, updated_at_utc, completed_at_utc, runtime_sec, finish_code, priority, backgrounder_id , new_extract_id, datasources_size, extract_size, db_class, state, owner_type) FROM '/home/tableau_srv/scripts/extract_timings_export.csv' DELIMITER '|' CSV;

INSERT INTO rpt_internal.tbl_tableau_ingestion_records (tableau_repo_environment, title, id_order, id, job_name, progress, first_published_at_utc, created_at_utc, started_at_utc, updated_at_utc, completed_at_utc, runtime_sec, finish_code, priority, backgrounder_id , new_extract_id, datasources_size, extract_size, db_class, state, owner_type) SELECT :tableau_repo_environment, title, id_order, id, job_name, progress, first_published_at_utc, created_at_utc, started_at_utc, updated_at_utc, completed_at_utc, runtime_sec, finish_code, priority, backgrounder_id , new_extract_id, datasources_size, extract_size, db_class, state, owner_type FROM tbl_tableau_ingestion_records_temp WHERE tbl_tableau_ingestion_records_temp.id NOT IN (SELECT id FROM rpt_internal.tbl_tableau_ingestion_records) ON CONFLICT DO NOTHING;

DROP TABLE tbl_tableau_ingestion_records_temp;
